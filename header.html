<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCxjTmRPiF4OrRAsneB_SUi1SpGOgkwrYg",
    authDomain: "genzet-home.firebaseapp.com",
    projectId: "genzet-home",
    storageBucket: "genzet-home.appspot.com",
    messagingSenderId: "586231239859",
    appId: "1:586231239859:web:9fc3a69f2f2ef0bf8c8cc6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const form = document.getElementById("pengeluaranForm");
  const tbody = document.querySelector("#tablePengeluaran tbody");
  const totalEl = document.getElementById("totalPengeluaran");
  const statusEl = document.getElementById("status");

  let total = 0;

  async function loadData() {
    tbody.innerHTML = "";
    total = 0;
    const snapshot = await getDocs(collection(db, "pengeluaran"));
    let nomor = 1;

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      total += parseInt(data.jumlah || 0);

      const buktiLink = data.bukti ? `<a href="${data.bukti}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fa-solid fa-file-arrow-down"></i> Bukti</a>` : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${nomor++}</td>
        <td>${data.keterangan}</td>
        <td>Rp ${parseInt(data.jumlah).toLocaleString()}</td>
        <td>${buktiLink}</td>
        <td><button class="btn btn-sm btn-danger" data-id="${docSnap.id}" data-url="${data.bukti || ""}"><i class="fa-solid fa-trash"></i></button></td>
      `;
      tbody.appendChild(tr);
    });
    totalEl.textContent = "Rp " + total.toLocaleString();
  }

  form.addEventListener("submit", async e => {
    e.preventDefault();

    try {
      const keterangan = document.getElementById("keterangan").value;
      const jumlah = document.getElementById("jumlah").value;
      const bukti = document.getElementById("bukti").files[0];

      let url = "";

      if (bukti) {
        statusEl.textContent = "Mengunggah bukti...";
        const buktiRef = ref(storage, `bukti/${Date.now()}_${bukti.name}`);
        await uploadBytes(buktiRef, bukti);
        url = await getDownloadURL(buktiRef);
      }

      statusEl.textContent = "Menyimpan data...";
      await addDoc(collection(db, "pengeluaran"), {
        keterangan,
        jumlah,
        bukti: url
      });

      form.reset();
      statusEl.textContent = "✅ Data berhasil disimpan.";
      await loadData();
    } catch (err) {
      console.error(err);
      statusEl.textContent = "❗ Gagal menyimpan data.";
    } finally {
      setTimeout(() => statusEl.textContent = "", 3000);
    }
  });

  tbody.addEventListener("click", async e => {
    if (e.target.closest("button[data-id]")) {
      const button = e.target.closest("button[data-id]");
      const id = button.getAttribute("data-id");
      const fileURL = button.getAttribute("data-url");

      await deleteDoc(doc(db, "pengeluaran", id));

      if (fileURL) {
        try {
          const fileRef = ref(storage, fileURL);
          await deleteObject(fileRef);
        } catch (error) {
          console.warn("Gagal menghapus file dari storage, mungkin sudah tidak ada.");
        }
      }

      await loadData();
    }
  });

  loadData();
</script>
