<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grafik Keuangan - GENZET HOME</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { background-color: #f8f9fa; }
    .main-content { max-width: 960px; margin: 0 auto; padding: 2rem 1rem; }
  </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light mb-4 border-bottom">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">GENZET HOME</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a href="index.html" class="nav-link text-dark"><i class="fa-solid fa-house"></i> Beranda</a></li>
        <li class="nav-item"><a href="pemasukan.html" class="nav-link text-dark"><i class="fa-solid fa-wallet"></i> Pemasukan</a></li>
        <li class="nav-item"><a href="pengeluaran.html" class="nav-link text-dark"><i class="fa-solid fa-money-bill-wave"></i> Pengeluaran</a></li>
        <li class="nav-item"><button class="btn btn-link nav-link text-dark" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i> Logout</button></li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-content">
  <h4 class="text-center mb-4 fs-5"><i class="fa-solid fa-chart-line"></i> Grafik Keuangan</h4>

  <div class="mb-3 text-end">
    <button class="btn btn-primary" onclick="filterPeriode()"><i class="fa-solid fa-calendar-days"></i> Filter Periode</button>
  </div>

  <div class="card mb-4 border-success">
    <div class="card-header bg-success text-white"><i class="fa-solid fa-chart-column"></i> Grafik Pemasukan & Pengeluaran</div>
    <div class="card-body">
      <canvas id="chartKeuangan" height="120"></canvas>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCxjTmRPiF4OrRAsneB_SUi1SpGOgkwrYg",
    authDomain: "genzet-home.firebaseapp.com",
    projectId: "genzet-home",
    storageBucket: "genzet-home.appspot.com",
    messagingSenderId: "586231239859",
    appId: "1:586231239859:web:9fc3a69f2f2ef0bf8c8cc6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let pemasukanData = [], pengeluaranData = [], chart;

  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "login.html";
  });

  async function loadData() {
    pemasukanData = [], pengeluaranData = [];

    const pemasukanSnap = await getDocs(collection(db, "pemasukan"));
    pemasukanSnap.forEach(doc => pemasukanData.push(doc.data()));

    const pengeluaranSnap = await getDocs(collection(db, "pengeluaran"));
    pengeluaranSnap.forEach(doc => pengeluaranData.push(doc.data()));

    renderChart(pemasukanData, pengeluaranData);
  }

  function renderChart(pemasukanArray, pengeluaranArray) {
    const totalPemasukan = pemasukanArray.reduce((sum, d) => sum + parseInt(d.jumlah || 0), 0);
    const totalPengeluaran = pengeluaranArray.reduce((sum, d) => sum + parseInt(d.jumlah || 0), 0);

    const ctx = document.getElementById("chartKeuangan").getContext("2d");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Pemasukan", "Pengeluaran"],
        datasets: [{
          label: "Jumlah (Rp)",
          data: [totalPemasukan, totalPengeluaran],
          backgroundColor: ["#28a745", "#dc3545"]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function filterPeriode() {
    Swal.fire({
      title: "Filter Periode",
      html: `
        <input type="text" id="start" class="swal2-input" placeholder="Tanggal Awal (dd-mm-yy)">
        <input type="text" id="end" class="swal2-input" placeholder="Tanggal Akhir (dd-mm-yy)">
      `,
      confirmButtonText: "Tampilkan",
      preConfirm: () => {
        const start = document.getElementById("start").value.trim();
        const end = document.getElementById("end").value.trim();
        if (!start || !end) return Swal.showValidationMessage("Lengkapi kedua tanggal!");
        filterDataByPeriode(start, end);
      }
    });
  }

  function filterDataByPeriode(startDate, endDate) {
    const toDate = (tgl) => {
      const [d, m, y] = tgl.split("-").map(Number);
      return new Date(2000 + y, m - 1, d);
    };
    const start = toDate(startDate);
    const end = toDate(endDate);

    const pemasukanFiltered = pemasukanData.filter(d => d.tanggal ? toDate(d.tanggal) >= start && toDate(d.tanggal) <= end : false);
    const pengeluaranFiltered = pengeluaranData.filter(d => d.tanggal ? toDate(d.tanggal) >= start && toDate(d.tanggal) <= end : false);

    renderChart(pemasukanFiltered, pengeluaranFiltered);
  }

  async function logout() {
    Swal.fire({
      title: 'Keluar dari akun?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Ya, Logout',
      cancelButtonText: 'Batal'
    }).then(async (result) => {
      if (result.isConfirmed) {
        await signOut(auth);
        Swal.fire({ icon: 'success', title: 'Logout berhasil', showConfirmButton: false, timer: 1500 })
          .then(() => window.location.href = "login.html");
      }
    });
  }

  loadData();
</script>
</body>
</html>
